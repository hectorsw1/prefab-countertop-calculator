<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stone Prefab Calculator</title>
  <style>
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #111111;
      --bg-card: #1a1a1a;
      --bg-input: #222222;
      --border: #333333;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --text-muted: #888888;
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-orange: #f59e0b;
      --accent-red: #ef4444;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
    }

    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      text-align: center;
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 600;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .config-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }

    .config-section h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 0.9rem;
    }

    select, input {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.75rem;
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .sink-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
    }

    .sink-group {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1rem;
    }

    .sink-group h3 {
      font-size: 1rem;
      margin-bottom: 0.75rem;
      color: var(--accent-blue);
    }

    .btn {
      background: var(--accent-blue);
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }

    .btn-success {
      background: var(--accent-green);
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-small {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }

    .sections-container {
      margin-bottom: 2rem;
    }

    .sections-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .sections-header h2 {
      font-size: 1.25rem;
    }

    .quick-add {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
    }

    .quick-add h3 {
      font-size: 1rem;
      margin-bottom: 0.75rem;
      color: var(--accent-blue);
    }

    .quick-add-grid {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 2fr 1fr auto;
      gap: 0.75rem;
      align-items: end;
    }

    .section-list {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      max-height: 400px;
      overflow-y: auto;
    }

    .section-item {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 2fr 1fr auto;
      gap: 0.75rem;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      align-items: center;
    }

    .section-item:last-child {
      border-bottom: none;
    }

    .section-item:hover {
      background: var(--bg-card);
    }

    .section-item input, .section-item select {
      padding: 0.4rem 0.6rem;
      font-size: 0.85rem;
    }

    .remove-btn {
      background: var(--accent-red);
      color: white;
      border: none;
      border-radius: 0.3rem;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .remove-btn:hover {
      background: #dc2626;
    }

    .calculate-section {
      text-align: center;
      margin: 2rem 0;
    }

    .calculate-btn {
      background: var(--accent-green);
      font-size: 1.1rem;
      padding: 1rem 2rem;
    }

    .total-calculator-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }

    .pricing-breakdown {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .pricing-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    .pricing-line:last-child {
      border-bottom: none;
      font-weight: 600;
      color: var(--text-primary);
    }

    .adjustment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .final-total {
      background: var(--bg-input);
      border: 2px solid var(--accent-green);
      border-radius: 0.75rem;
      padding: 1.5rem;
      text-align: center;
    }

    .total-display {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
    }

    .total-label {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .total-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-green);
    }

    .results-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .summary-item {
      background: var(--bg-input);
      padding: 1rem;
      border-radius: 0.5rem;
      text-align: center;
      border: 1px solid var(--border);
    }

    .summary-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--accent-blue);
    }

    .summary-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .pieces-summary, .leftovers-summary, .plywood-summary {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .pieces-summary h3, .leftovers-summary h3, .plywood-summary h3 {
      color: var(--text-primary);
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .pieces-list, .leftovers-list, .plywood-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .piece-tag, .leftover-tag, .plywood-tag {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .piece-tag {
      color: var(--accent-blue);
    }

    .leftover-tag {
      color: var(--accent-orange);
    }

    .plywood-tag {
      color: var(--accent-green);
    }

    .empty-state {
      text-align: center;
      color: var(--text-muted);
      padding: 2rem;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .config-grid,
      .adjustment-grid,
      .sink-section {
        grid-template-columns: 1fr;
      }
      
      .quick-add-grid,
      .section-item {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Stone Prefab Calculator</h1>
  </header>

  <div class="container">
    <!-- Configuration -->
    <section class="config-section">
      <h2>Project Configuration</h2>
      <div class="config-grid">
        <div class="form-group">
          <label for="material">Material Type</label>
          <select id="material" onchange="loadStoneColors()">
            <option value="">Select material...</option>
            <option value="Quartz">Quartz</option>
            <option value="Granite">Granite</option>
            <option value="Quartzite">Quartzite</option>
            <option value="Marble">Marble</option>
          </select>
        </div>
        <div class="form-group">
          <label for="stone-color">Stone Color</label>
          <select id="stone-color" disabled>
            <option value="">Select material first...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edge-type">Edge Type</label>
          <select id="edge-type">
            <option value="">Select edge type...</option>
            <option value="basic">Basic Edge ($14/sq ft)</option>
            <option value="mitered">Mitered Edge ($16/sq ft)</option>
          </select>
        </div>
      </div>

      <!-- Sink Configuration -->
      <div class="sink-section">
        <div class="sink-group">
          <h3>Kitchen Sinks</h3>
          <div class="form-group">
            <label for="kitchen-sink-type">Kitchen Sink Type</label>
            <select id="kitchen-sink-type">
              <option value="none">No Kitchen Sink</option>
              <option value="free-kitchen">Free Kitchen Sink ($180)</option>
              <option value="handmade-kitchen">HandMade Kitchen Sink ($275)</option>
              <option value="handmade-workstation">HandMade WorkStation Sink ($320)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="kitchen-sink-qty">Kitchen Sink Quantity</label>
            <input type="number" id="kitchen-sink-qty" min="0" max="10" value="0" placeholder="0">
          </div>
        </div>

        <div class="sink-group">
          <h3>Bathroom Sinks</h3>
          <div class="form-group">
            <label for="bathroom-sink-qty">Bathroom Sink Quantity</label>
            <input type="number" id="bathroom-sink-qty" min="0" max="10" value="0" placeholder="0">
          </div>
          <div style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">
            $80 per bathroom sink
          </div>
        </div>
      </div>
    </section>

    <!-- Sections -->
    <section class="sections-container">
      <div class="sections-header">
        <h2>Project Sections</h2>
      </div>

      <!-- Quick Add -->
      <div class="quick-add">
        <h3>Quick Add Section</h3>
        <div class="quick-add-grid">
          <input type="text" id="quick-name" placeholder="Section name (e.g., Kitchen Island)">
          <input type="number" id="quick-length" placeholder="Length" min="1">
          <input type="number" id="quick-width" placeholder="Width" min="1">
          <select id="quick-type">
            <option value="countertop">Countertop</option>
            <option value="island">Island</option>
          </select>
          <select id="quick-joint">
            <option value="standalone">Standalone</option>
            <option value="jointed">Jointed</option>
          </select>
          <button class="btn btn-small" onclick="addSection()">+ Add</button>
        </div>
      </div>

      <!-- Section List -->
      <div class="section-list" id="sections-list">
        <div class="section-item" style="font-weight: 600; background: var(--bg-card);">
          <div>Section Name</div>
          <div>Length (in)</div>
          <div>Width (in)</div>
          <div>Type</div>
          <div>Joint Status</div>
          <div>Remove</div>
        </div>
      </div>
    </section>

    <!-- Calculate Button -->
    <section class="calculate-section">
      <button class="btn calculate-btn" onclick="calculateAll()">
        Calculate Stone Requirements
      </button>
    </section>

    <!-- Total Calculator -->
    <section class="total-calculator-section">
      <h2>Total Project Calculator</h2>
      <div id="pricing-breakdown" class="pricing-breakdown">
        <div class="empty-state">Calculate to see pricing breakdown</div>
      </div>
      
      <div class="manual-adjustments">
        <h3>Manual Adjustments</h3>
        <div class="adjustment-grid">
          <div class="form-group">
            <label for="customer-sink">Customer Supplied Sink(s)</label>
            <input type="number" id="customer-sink" step="0.01" placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="oversize-fee">Oversize Piece Fee</label>
            <input type="number" id="oversize-fee" step="0.01" placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="added-fabrication">Added Fabrication</label>
            <input type="number" id="added-fabrication" step="0.01" placeholder="0.00">
          </div>
        </div>
        
        <div class="final-total">
          <div class="total-display">
            <span class="total-label">Project Total:</span>
            <span class="total-value" id="final-total">$0.00</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section class="results-section">
      <h2>Project Details</h2>
      <div id="results">
        <div class="empty-state">
          Add sections and calculate to see results
        </div>
      </div>
    </section>
  </div>

  <script>
    let sectionCounter = 0;
    let sections = [];
    let currentResults = null;
    let stoneData = {}; // Will store all CSV data

    // Load CSV data on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadAllCSVs();
    });

    async function loadAllCSVs() {
      const materials = ['Granite', 'Marble', 'Quartz', 'Quartzite'];

      for (const material of materials) {
        try {
          // Try the most likely relative paths. Use relative (no leading slash)
          // so it works when opening the file from a local server or file tree.
          const candidatePaths = [`./CSV/${material}_tidy.csv`, `./csv/${material}_tidy.csv`];
          let response = null;

          for (const p of candidatePaths) {
            try {
              response = await fetch(p);
              if (response.ok) {
                break;
              }
            } catch (e) {
              // swallow and try next path
              response = null;
            }
          }

          if (!response || !response.ok) {
            throw new Error(`CSV not found. Tried: ${candidatePaths.join(' , ')}`);
          }

          const csvText = await response.text();
          stoneData[material] = parseCSV(csvText);
          console.log(`Loaded ${material}: ${stoneData[material].length} pieces from ${response.url}`);
        } catch (error) {
          console.error(`Error loading ${material} CSV:`, error);
          stoneData[material] = [];
        }
      }
    }

    function parseCSV(csvText) {
      if (!csvText || !csvText.trim()) return [];

      // Normalize line endings and skip empty lines
      const lines = csvText.replace(/\r/g, '').split('\n').map(l => l.trim()).filter(l => l.length > 0);
      if (lines.length === 0) return [];

      const headers = lines[0].split(',').map(h => h.trim());
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(',');
        const item = {};

        headers.forEach((header, index) => {
          item[header] = row[index] ? row[index].trim() : '';
        });

        // Convert size columns to numbers (safe)
        item.size_L_in = parseInt(item.size_L_in) || 0;
        item.size_W_in = parseInt(item.size_W_in) || 0;

        if (item.size_L_in > 0 && item.size_W_in > 0) {
          data.push(item);
        }
      }

      return data;
    }

    function loadStoneColors() {
      const material = document.getElementById('material').value;
      const stoneColorSelect = document.getElementById('stone-color');
      
      stoneColorSelect.innerHTML = '<option value="">Select stone color...</option>';
      stoneColorSelect.disabled = true;
      
      if (material && stoneData[material]) {
        const colors = [...new Set(stoneData[material].map(item => item.color))].sort();
        
        colors.forEach(color => {
          const option = document.createElement('option');
          option.value = color;
          option.textContent = color;
          stoneColorSelect.appendChild(option);
        });
        
        stoneColorSelect.disabled = false;
      }
    }

    function addSection() {
      const name = document.getElementById('quick-name').value.trim() || `Section ${String.fromCharCode(65 + sectionCounter)}`;
      const length = parseFloat(document.getElementById('quick-length').value);
      const width = parseFloat(document.getElementById('quick-width').value);
      const type = document.getElementById('quick-type').value;
      const joint = document.getElementById('quick-joint').value;

      if (!length || !width || length <= 0 || width <= 0) {
        alert('Please enter valid positive numbers for length and width');
        return;
      }

      sectionCounter++;
      const sectionId = `section-${sectionCounter}`;

      sections.push({
        id: sectionId,
        name: name,
        length: length,
        width: width,
        type: type,
        joint: joint
      });

      renderSectionList();

      document.getElementById('quick-name').value = '';
      document.getElementById('quick-length').value = '';
      document.getElementById('quick-width').value = '';
    }

    function removeSection(sectionId) {
      sections = sections.filter(s => s.id !== sectionId);
      renderSectionList();
    }

    function renderSectionList() {
      const container = document.getElementById('sections-list');
      
      let html = `
        <div class="section-item" style="font-weight: 600; background: var(--bg-card);">
          <div>Section Name</div>
          <div>Length (in)</div>
          <div>Width (in)</div>
          <div>Type</div>
          <div>Joint Status</div>
          <div>Remove</div>
        </div>
      `;

      sections.forEach(section => {
        html += `
          <div class="section-item">
            <input type="text" value="${section.name}" onchange="updateSectionName('${section.id}', this.value)">
            <input type="number" value="${section.length}" min="1" onchange="updateSectionValue('${section.id}', 'length', this.value)">
            <input type="number" value="${section.width}" min="1" onchange="updateSectionValue('${section.id}', 'width', this.value)">
            <select onchange="updateSectionValue('${section.id}', 'type', this.value)">
              <option value="countertop" ${section.type === 'countertop' ? 'selected' : ''}>Countertop</option>
              <option value="island" ${section.type === 'island' ? 'selected' : ''}>Island</option>
            </select>
            <select onchange="updateSectionValue('${section.id}', 'joint', this.value)">
              <option value="standalone" ${section.joint === 'standalone' ? 'selected' : ''}>Standalone</option>
              <option value="jointed" ${section.joint === 'jointed' ? 'selected' : ''}>Jointed</option>
            </select>
            <button class="remove-btn" onclick="removeSection('${section.id}')">×</button>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function updateSectionName(sectionId, newName) {
      const section = sections.find(s => s.id === sectionId);
      if (section) section.name = newName;
    }

    function updateSectionValue(sectionId, property, value) {
      const section = sections.find(s => s.id === sectionId);
      if (section) {
        if (property === 'length' || property === 'width') {
          section[property] = parseFloat(value) || 0;
        } else {
          section[property] = value;
        }
      }
    }

    function calculateAll() {
      const material = document.getElementById('material').value;
      const stoneColor = document.getElementById('stone-color').value;
      const edgeType = document.getElementById('edge-type').value;
      const kitchenSinkType = document.getElementById('kitchen-sink-type').value;
      const kitchenSinkQty = parseInt(document.getElementById('kitchen-sink-qty').value) || 0;
      const bathroomSinkQty = parseInt(document.getElementById('bathroom-sink-qty').value) || 0;

      if (!material) {
        alert('Please select a material');
        return;
      }

      if (!stoneColor) {
        alert('Please select a stone color');
        return;
      }

      if (!edgeType) {
        alert('Please select an edge type');
        return;
      }

      if (sections.length === 0) {
        alert('Please add at least one section');
        return;
      }

      // Get available stones for the selected material and color
      const availableStones = stoneData[material] ? 
        stoneData[material].filter(stone => stone.color === stoneColor) : [];

      if (availableStones.length === 0) {
        alert(`No stone pieces available for ${material} - ${stoneColor}`);
        return;
      }

      const results = {
        material: material,
        stoneColor: stoneColor,
        edgeType: edgeType,
        edgePrice: edgeType === 'basic' ? 14 : 16,
        kitchenSinkType: kitchenSinkType,
        kitchenSinkQty: kitchenSinkQty,
        bathroomSinkQty: bathroomSinkQty,
        sections: [],
        totals: {},
        errors: []
      };

      // Process sections with smart stone suggestion
      let totalInputSqFt = 0;
      let totalStoneSqFt = 0;
      const stonePieces = {};
      const plywoodPieces = [];
      const leftovers = [];

      sections.forEach(section => {
        const inputArea = section.length * section.width / 144;
        
        // Find best stone for this section
        const bestStone = findBestStone(availableStones, section.length, section.width, section.type);
        
        if (!bestStone.found) {
          results.errors.push(`${section.name}: ${bestStone.message}`);
          return;
        }
        
        const stone = bestStone.stone;
        const stoneArea = stone.size_L_in * stone.size_W_in / 144;
        
        const plywoodLength = Math.max(1, section.length - 2);
        const plywoodWidth = Math.max(1, section.width - 3);
        
        // Stone pieces count
        const stoneSize = `${stone.size_L_in}" × ${stone.size_W_in}"`;
        stonePieces[stoneSize] = (stonePieces[stoneSize] || 0) + 1;
        
        // Plywood pieces
        plywoodPieces.push({
          name: section.name,
          length: plywoodLength,
          width: plywoodWidth
        });
        
        // Leftovers (only if > 26" both dimensions)
        const leftoverLength = stone.size_L_in - section.length;
        const leftoverWidth = stone.size_W_in - section.width;
        if (leftoverLength > 26 && leftoverWidth > 26) {
          leftovers.push({
            name: section.name,
            size: `${leftoverLength}" × ${leftoverWidth}"`
          });
        }
        
        totalInputSqFt += inputArea;
        totalStoneSqFt += stoneArea;
        
        results.sections.push({
          ...section,
          inputArea: inputArea,
          suggestedStone: stoneSize,
          stoneArea: stoneArea,
          waste: stoneArea - inputArea,
          plywoodSize: `${plywoodLength}" × ${plywoodWidth}"`,
          stoneInfo: `${stone.color} - ${stone.type}`
        });
      });

      // Show errors if any
      if (results.errors.length > 0) {
        alert('Issues found:\n' + results.errors.join('\n'));
      }

// Simple accurate plywood packing
let sheets = [];

// Sort by width (widest first) for better packing
plywoodPieces.sort((a, b) => b.width - a.width);

plywoodPieces.forEach(piece => {
  let placed = false;
  
  // Try to fit on existing sheets
  for (let sheet of sheets) {
    if (sheet.usedWidth + piece.width <= 48) {
      sheet.usedWidth += piece.width;
      sheet.totalLength += piece.length;
      placed = true;
      break;
    }
  }
  
  // Start new sheet if doesn't fit
  if (!placed) {
    sheets.push({
      usedWidth: piece.width,
      totalLength: piece.length
    });
  }
});

// Adjust for jointing capability
// If total length on a sheet > 96", but pieces are similar size, jointing is viable
let plywoodSheets = 0;
sheets.forEach(sheet => {
  // Each sheet can provide ~96" base + joints from offcuts
  // If total length needed is under ~150", one sheet suffices with joints
  if (sheet.totalLength <= 150 && sheet.usedWidth <= 48) {
    plywoodSheets++;
  } else {
    // Need multiple sheets for this group
    plywoodSheets += Math.ceil(sheet.totalLength / 96);
  }
});

plywoodSheets = Math.max(1, plywoodSheets);
      // Calculate costs
      const kitchenSinkPrice = kitchenSinkType === 'free-kitchen' ? 180 : 
                             kitchenSinkType === 'handmade-kitchen' ? 275 : 
                             kitchenSinkType === 'handmade-workstation' ? 320 : 0;
      
      const totalKitchenSinkCost = kitchenSinkPrice * kitchenSinkQty;
      const totalBathroomSinkCost = 80 * bathroomSinkQty;
      const totalSinkCost = totalKitchenSinkCost + totalBathroomSinkCost;
      const plywoodCost = plywoodSheets * 70;
      const edgeCost = Math.ceil(totalInputSqFt) * results.edgePrice;
      const grandTotal = edgeCost + totalSinkCost + plywoodCost;

      results.totals = {
        inputSqFt: totalInputSqFt,
        inputSqFtRounded: Math.ceil(totalInputSqFt),
        stoneSqFt: totalStoneSqFt,
        totalWaste: totalStoneSqFt - totalInputSqFt,
        stonesPieces: results.sections.length,
        plywoodSheets: plywoodSheets,
        edgeCost: edgeCost,
        totalKitchenSinkCost: totalKitchenSinkCost,
        totalBathroomSinkCost: totalBathroomSinkCost,
        totalSinkCost: totalSinkCost,
        plywoodCost: plywoodCost,
        grandTotal: grandTotal
      };

      results.stonePiecesSummary = stonePieces;
      results.leftovers = leftovers;
      results.plywoodLeftovers = plywoodPieces;

      displayResults(results);
      displayPricingBreakdown(results);
      currentResults = results;
    }

    function findBestStone(availableStones, needLength, needWidth, sectionType, material, allSections, currentSection) {
  // Find stones that fit
  const fittingStones = availableStones.filter(stone => 
    (stone.size_L_in >= needLength && stone.size_W_in >= needWidth) ||
    (stone.size_L_in >= needWidth && stone.size_W_in >= needLength)
  );

  if (fittingStones.length === 0) {
    return {
      found: false,
      message: `No stone available for ${needLength}" × ${needWidth}". Try different color.`
    };
  }

  // Check if this section is jointed with others (natural stone rule)
  const isNaturalStone = ['Granite', 'Marble', 'Quartzite'].includes(material);
  
  if (isNaturalStone && currentSection.joint === 'jointed') {
    // Find all other jointed sections
    const jointedSections = allSections.filter(s => s.joint === 'jointed' && s.id !== currentSection.id);
    
    if (jointedSections.length > 0) {
      // Get the stone sizes already used by jointed sections
      const usedSizes = jointedSections
        .filter(s => s.suggestedStone)
        .map(s => s.suggestedStone);
      
      if (usedSizes.length > 0) {
        // Must use the same size as other jointed sections
        const requiredSize = usedSizes[0];
        const [reqL, reqW] = requiredSize.split('" × ').map(s => parseInt(s));
        
        const matchingStone = fittingStones.find(stone => 
          stone.size_L_in === reqL && stone.size_W_in === reqW
        );
        
        if (matchingStone) {
          return { found: true, stone: matchingStone };
        } else {
          return {
            found: false,
            message: `Jointed sections must use ${requiredSize}. Not available for this section.`
          };
        }
      }
    }
  }

  // Sort by least waste
  fittingStones.sort((a, b) => {
    const wasteA = (a.size_L_in * a.size_W_in) - (needLength * needWidth);
    const wasteB = (b.size_L_in * b.size_W_in) - (needLength * needWidth);
    if (wasteA !== wasteB) return wasteA - wasteB;
    return (a.size_L_in * a.size_W_in) - (b.size_L_in * b.size_W_in);
  });

  return { found: true, stone: fittingStones[0] };
}

    function displayResults(results) {
      let html = `
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-value">${results.totals.inputSqFtRounded}</div>
            <div class="summary-label">Rounded Sq Ft for Pricing</div>
          </div>
          <div class="summary-item">
            <div class="summary-value">${results.totals.stoneSqFt.toFixed(1)}</div>
            <div class="summary-label">Total Stone Sq Ft</div>
          </div>
          <div class="summary-item">
            <div class="summary-value">${results.totals.totalWaste.toFixed(1)}</div>
            <div class="summary-label">Total Waste Sq Ft</div>
          </div>
          <div class="summary-item">
            <div class="summary-value">$${results.totals.grandTotal.toFixed(0)}</div>
            <div class="summary-label">Project Total</div>
          </div>
        </div>
      `;
      
      html += `
        <div class="pieces-summary">
          <h3>Stone Pieces Required</h3>
          <div class="pieces-list">
      `;
      
      Object.entries(results.stonePiecesSummary).forEach(([size, count]) => {
        html += `<div class="piece-tag">${count} × ${size}</div>`;
      });
      
      html += `</div></div>`;
      
      if (results.leftovers.length > 0) {
        html += `
          <div class="leftovers-summary">
            <h3>Stone Leftovers (> 26" × 26")</h3>
            <div class="leftovers-list">
        `;
        
        results.leftovers.forEach(leftover => {
          html += `<div class="leftover-tag">${leftover.name}: ${leftover.size}</div>`;
        });
        
        html += `</div></div>`;
      }
      
      html += `
        <div class="plywood-summary">
          <h3>Plywood Requirements</h3>
          <p style="color: var(--text-secondary); margin-bottom: 1rem;">
            <strong>${results.totals.plywoodSheets}</strong> sheets of 48" × 96" plywood needed @ $70/sheet = <strong>$${results.totals.plywoodCost}</strong>
          </p>
          <div class="plywood-list">
      `;
      
      results.plywoodLeftovers.forEach(plywood => {
        html += `<div class="plywood-tag">${plywood.name}: ${plywood.length}" × ${plywood.width}"</div>`;
      });
      
      html += `</div></div>`;
      
      document.getElementById('results').innerHTML = html;
    }

    function displayPricingBreakdown(results) {
      const kitchenSinkInfo = results.kitchenSinkQty > 0 ? ` (${results.kitchenSinkQty}x ${results.kitchenSinkType.replace('-', ' ')})` : '';
      const bathroomSinkInfo = results.bathroomSinkQty > 0 ? ` (${results.bathroomSinkQty}x)` : '';
      
      let breakdown = `
        <div class="pricing-line">
          <span class="label">Edge Work (${results.totals.inputSqFtRounded} sq ft × ${results.edgePrice})</span>
          <span class="value">${results.totals.edgeCost.toFixed(2)}</span>
        </div>
      `;
      
      if (results.totals.totalKitchenSinkCost > 0) {
        breakdown += `
        <div class="pricing-line">
          <span class="label">Kitchen Sink Cutouts${kitchenSinkInfo}</span>
          <span class="value">${results.totals.totalKitchenSinkCost.toFixed(2)}</span>
        </div>`;
      }
      
      if (results.totals.totalBathroomSinkCost > 0) {
        breakdown += `
        <div class="pricing-line">
          <span class="label">Bathroom Sink Cutouts${bathroomSinkInfo}</span>
          <span class="value">${results.totals.totalBathroomSinkCost.toFixed(2)}</span>
        </div>`;
      }
      
      breakdown += `
        <div class="pricing-line">
          <span class="label">Plywood (${results.totals.plywoodSheets} sheets)</span>
          <span class="value">${results.totals.plywoodCost.toFixed(2)}</span>
        </div>
        <div class="pricing-line">
          <span class="label">Subtotal</span>
          <span class="value">${results.totals.grandTotal.toFixed(2)}</span>
        </div>
      `;
      
      document.getElementById('pricing-breakdown').innerHTML = breakdown;
      updateFinalTotal(results.totals.grandTotal);
      
      // Add event listeners for manual adjustments
      ['customer-sink', 'oversize-fee', 'added-fabrication'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.removeEventListener('input', updateFinalTotalHandler);
          element.addEventListener('input', updateFinalTotalHandler);
        }
      });
    }

    function updateFinalTotalHandler() {
      if (currentResults) {
        updateFinalTotal(currentResults.totals.grandTotal);
      }
    }

    function updateFinalTotal(baseTotal) {
      const customerSink = parseFloat(document.getElementById('customer-sink').value) || 0;
      const oversizeFee = parseFloat(document.getElementById('oversize-fee').value) || 0;
      const addedFabrication = parseFloat(document.getElementById('added-fabrication').value) || 0;
      
      const finalTotal = baseTotal + customerSink + oversizeFee + addedFabrication;
      const finalTotalElement = document.getElementById('final-total');
      if (finalTotalElement) {
        finalTotalElement.textContent = `${finalTotal.toFixed(2)}`;
      }
    }
  </script>
</body>
</html>
